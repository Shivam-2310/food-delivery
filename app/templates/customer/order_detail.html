{% extends 'base.html' %}

{% block title %}Order #{{ order.id }} - JustEat{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ORDER #{{ order.id }}</h1>
        <a href="{{ url_for('customer.orders') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> BACK TO ORDERS
        </a>
    </div>
    
    <!-- ORDER STATUS -->
    <div class="card border-0 shadow mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h4 class="mb-4">ORDER STATUS</h4>
                    <div class="position-relative mb-4">
                        <div class="progress" style="height: 4px;">
                            {% if order.status == 'cancelled' %}
                                <div class="progress-bar bg-danger" role="progressbar" style="width: 100%;"></div>
                            {% else %}
                                {% set progress = {
                                    'pending': 20,
                                    'confirmed': 40,
                                    'preparing': 60,
                                    'ready': 80,
                                    'completed': 100
                                } %}
                                <div class="progress-bar bg-primary" role="progressbar" style="width: {{ progress[order.status] }}%;"></div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex justify-content-between mt-2">
                            <div class="text-center">
                                <div class="rounded-circle {% if order.status != 'cancelled' %}bg-primary{% else %}bg-secondary{% endif %} text-white" style="width: 30px; height: 30px; line-height: 30px;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="mt-1">Pending</div>
                            </div>
                            
                            <div class="text-center">
                                <div class="rounded-circle {% if order.status != 'cancelled' and order.status != 'pending' %}bg-primary{% else %}bg-secondary{% endif %} text-white" style="width: 30px; height: 30px; line-height: 30px;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="mt-1">Confirmed</div>
                            </div>
                            
                            <div class="text-center">
                                <div class="rounded-circle {% if order.status != 'cancelled' and order.status not in ['pending', 'confirmed'] %}bg-primary{% else %}bg-secondary{% endif %} text-white" style="width: 30px; height: 30px; line-height: 30px;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="mt-1">Preparing</div>
                            </div>
                            
                            <div class="text-center">
                                <div class="rounded-circle {% if order.status != 'cancelled' and order.status not in ['pending', 'confirmed', 'preparing'] %}bg-primary{% else %}bg-secondary{% endif %} text-white" style="width: 30px; height: 30px; line-height: 30px;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="mt-1">Ready</div>
                            </div>
                            
                            <div class="text-center">
                                <div class="rounded-circle {% if order.status == 'completed' %}bg-primary{% else %}bg-secondary{% endif %} text-white" style="width: 30px; height: 30px; line-height: 30px;">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="mt-1">Completed</div>
                            </div>
                        </div>
                    </div>
                    
                    {% if order.status == 'cancelled' %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i> THIS ORDER HAS BEEN CANCELLED.
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <div class="card bg-light border-0">
                        <div class="card-body">
                            <h5 class="card-title">ORDER INFORMATION</h5>
                            <p class="mb-1"><strong>Date:</strong> {{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p class="mb-1"><strong>Status:</strong> {{ order.status_display }}</p>
                            <p class="mb-1"><strong>Restaurant:</strong> {{ order.restaurant.name }}</p>
                            <p class="mb-0"><strong>Total:</strong> ₹{{ '%.2f'|format(order.total_amount) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ORDER ITEMS -->
    <div class="card border-0 shadow mb-4">
        <div class="card-header bg-white py-3">
            <h4 class="mb-0">ORDER ITEMS</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th class="text-center">PRICE</th>
                            <th class="text-center">QUANTITY</th>
                            <th class="text-end">SUBTOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items %}
                            <tr>
                                <td>{{ item.menu_item.name }}</td>
                                <td class="text-center">₹{{ '%.2f'|format(item.price) }}</td>
                                <td class="text-center">{{ item.quantity }}</td>
                                <td class="text-end">₹{{ '%.2f'|format(item.subtotal) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="3" class="text-end">TOTAL:</th>
                            <th class="text-end">₹{{ '%.2f'|format(order.total_amount) }}</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <!-- DISH RATINGS SECTION -->
    {% if order.status == 'completed' and can_rate_dishes %}
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-success text-white py-3">
                <h4 class="mb-0">RATE YOUR DISHES</h4>
            </div>
            <div class="card-body">
                <p class="mb-4">How would you rate each dish you ordered?</p>
                
                <form method="POST">
                    <div class="row g-3">
                        {% for item in order.items %}
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            {% if item.menu_item.image_path %}
                                                <img src="{{ url_for('static', filename='uploads/' + item.menu_item.image_path) }}" 
                                                     class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;" alt="{{ item.menu_item.name }}">
                                            {% else %}
                                                <img src="{{ url_for('static', filename='images/menu_item_default.jpg') }}" 
                                                     class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;" alt="Default image">
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-1">{{ item.menu_item.name }}</h6>
                                                <small class="text-muted">Qty: {{ item.quantity }}</small>
                                            </div>
                                        </div>
                                        
                                        <div class="text-center">
                                            <p class="mb-2">Rate this dish:</p>
                                            <div class="d-flex justify-content-center">
                                                <input type="hidden" id="dish_rating_{{ item.menu_item_id }}" name="dish_rating_{{ item.menu_item_id }}" value="5">
                                                <div class="dish-star-rating" data-item-id="{{ item.menu_item_id }}">
                                                    {% for i in range(1, 6) %}
                                                        <i class="far fa-star text-warning fa-2x mx-1 dish-rating-star" 
                                                           data-value="{{ i }}" 
                                                           data-item-id="{{ item.menu_item_id }}"></i>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="d-grid mt-4">
                        <button type="submit" name="dish_rating_submit" class="btn btn-success btn-lg">
                            <i class="fas fa-star me-2"></i> SUBMIT DISH RATINGS
                        </button>
                    </div>
                </form>
                
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const dishRatingStars = document.querySelectorAll('.dish-rating-star');
                        
                        dishRatingStars.forEach(star => {
                            star.style.cursor = 'pointer';
                            
                            star.addEventListener('click', function() {
                                const value = this.getAttribute('data-value');
                                const itemId = this.getAttribute('data-item-id');
                                const ratingInput = document.getElementById(`dish_rating_${itemId}`);
                                ratingInput.value = value;
                                updateDishStars(itemId, value);
                            });
                            
                            star.addEventListener('mouseover', function() {
                                const value = this.getAttribute('data-value');
                                const itemId = this.getAttribute('data-item-id');
                                highlightDishStars(itemId, value);
                            });
                        });
                        
                        document.querySelectorAll('.dish-star-rating').forEach(rating => {
                            rating.addEventListener('mouseout', function() {
                                const itemId = this.getAttribute('data-item-id');
                                const selectedRating = document.getElementById(`dish_rating_${itemId}`).value;
                                updateDishStars(itemId, selectedRating);
                            });
                        });
                        
                        function updateDishStars(itemId, rating) {
                            const stars = document.querySelectorAll(`[data-item-id="${itemId}"]`);
                            stars.forEach(star => {
                                const value = star.getAttribute('data-value');
                                if (value <= rating) {
                                    star.classList.remove('far');
                                    star.classList.add('fas');
                                } else {
                                    star.classList.remove('fas');
                                    star.classList.add('far');
                                }
                            });
                        }
                        
                        function highlightDishStars(itemId, rating) {
                            const stars = document.querySelectorAll(`[data-item-id="${itemId}"]`);
                            stars.forEach(star => {
                                const value = star.getAttribute('data-value');
                                if (value <= rating) {
                                    star.classList.remove('far');
                                    star.classList.add('fas');
                                } else {
                                    star.classList.remove('fas');
                                    star.classList.add('far');
                                }
                            });
                        }
                    });
                </script>
            </div>
        </div>
    {% endif %}

    <!-- DISH RATINGS DISPLAY (if already submitted) -->
    {% if order.status == 'completed' and existing_dish_ratings %}
        <div class="card border-0 shadow mb-4">
            <div class="card-header bg-success text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">YOUR DISH RATINGS</h4>
                    <span class="badge bg-light text-success">SUBMITTED</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for item in order.items %}
                        {% if item.menu_item_id in existing_dish_ratings %}
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            {% if item.menu_item.image_path %}
                                                <img src="{{ url_for('static', filename='uploads/' + item.menu_item.image_path) }}" 
                                                     class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;" alt="{{ item.menu_item.name }}">
                                            {% else %}
                                                <img src="{{ url_for('static', filename='images/menu_item_default.jpg') }}" 
                                                     class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;" alt="Default image">
                                            {% endif %}
                                            <div>
                                                <h6 class="mb-1">{{ item.menu_item.name }}</h6>
                                                <small class="text-muted">Qty: {{ item.quantity }}</small>
                                            </div>
                                        </div>
                                        
                                        <div class="text-center">
                                            <div class="rating-display">
                                                {% set rating = existing_dish_ratings[item.menu_item_id] %}
                                                {% for i in range(1, 6) %}
                                                    <i class="{% if i <= rating %}fas{% else %}far{% endif %} fa-star text-warning fa-2x mx-1"></i>
                                                {% endfor %}
                                            </div>
                                            <p class="text-muted mt-2">You rated this dish {{ rating }} out of 5 stars</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}

    <!-- FEEDBACK & ACTIONS -->
    <div id="feedback" class="feedback-section pt-3 mt-2"></div>
    
    {% set order_has_feedback = existing_feedback is not none %}
    
    {% if order.status == 'completed' %}
        {% if not order_has_feedback %}
            <div class="card border-0 shadow mb-4">
                <div class="card-header bg-white py-3">
                    <h4 class="mb-0">RATE YOUR ORDER</h4>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% if feedback_form %}
                            {{ feedback_form.hidden_tag() }}
                        {% endif %}
                        
                        <div class="text-center mb-4">
                            <p class="mb-3">How would you rate your experience?</p>
                            <div class="d-flex justify-content-center">
                                <input type="hidden" id="selected_rating" name="rating" value="5">
                                <div class="star-rating">
                                    {% for i in range(1, 6) %}
                                        <i class="far fa-star text-warning fa-3x mx-2 rating-star" data-value="{{ i }}"></i>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="feedback-message" class="form-label">Your Feedback (Optional)</label>
                            <textarea id="feedback-message" name="message" class="form-control" rows="4" placeholder="Tell us about your experience..."></textarea>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i> SUBMIT FEEDBACK
                            </button>
                        </div>
                    </form>
                    
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            const stars = document.querySelectorAll('.rating-star');
                            const ratingInput = document.getElementById('selected_rating');
                            
                            // Handle star selection
                            stars.forEach(star => {
                                // Make stars interactive
                                star.style.cursor = 'pointer';
                                
                                star.addEventListener('click', function() {
                                    const value = this.getAttribute('data-value');
                                    ratingInput.value = value;
                                    updateStars(value);
                                });
                                
                                star.addEventListener('mouseover', function() {
                                    const value = this.getAttribute('data-value');
                                    highlightStars(value);
                                });
                            });
                            
                            document.querySelector('.star-rating').addEventListener('mouseout', function() {
                                const selectedRating = ratingInput.value;
                                updateStars(selectedRating);
                            });
                            
                            function updateStars(rating) {
                                stars.forEach(star => {
                                    const value = star.getAttribute('data-value');
                                    if (value <= rating) {
                                        star.classList.remove('far');
                                        star.classList.add('fas');
                                    } else {
                                        star.classList.remove('fas');
                                        star.classList.add('far');
                                    }
                                });
                            }
                            
                            function highlightStars(rating) {
                                stars.forEach(star => {
                                    const value = star.getAttribute('data-value');
                                    if (value <= rating) {
                                        star.classList.remove('far');
                                        star.classList.add('fas');
                                    } else {
                                        star.classList.remove('fas');
                                        star.classList.add('far');
                                    }
                                });
                            }
                        });
                    </script>
                </div>
            </div>
        {% else %}
            <div class="card border-0 shadow mb-4">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">YOUR FEEDBACK</h4>
                        <span class="badge bg-success">SUBMITTED</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="rating-display">
                            {% for i in range(1, 6) %}
                                <i class="{% if i <= existing_feedback.rating %}fas{% else %}far{% endif %} fa-star text-warning fa-2x mx-1"></i>
                            {% endfor %}
                        </div>
                        <p class="text-muted mt-2">You rated this order {{ existing_feedback.rating }} out of 5 stars</p>
                    </div>
                    
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Your Comments</h5>
                            <p class="card-text mb-0">{{ existing_feedback.message }}</p>
                        </div>
                    </div>
                    
                    {% if existing_feedback.response %}
                        <div class="card border-0 shadow-sm bg-light mb-0">
                            <div class="card-header bg-primary text-white">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-reply me-2"></i>
                                    <h5 class="mb-0">Restaurant Response</h5>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text mb-0">{{ existing_feedback.response }}</p>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <p class="mb-0">The restaurant has not yet responded to your feedback.</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% endif %}

    <!-- ACTIONS -->
    <div class="card border-0 shadow">
        <div class="card-body">
            <h4 class="mb-3">ACTIONS</h4>
            <div class="d-flex flex-wrap gap-2">
                {% if order.status == 'completed' %}
                    <a href="{{ url_for('customer.restaurant_detail', id=order.restaurant.id) }}" class="btn btn-primary">
                        <i class="fas fa-utensils"></i> ORDER AGAIN
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
